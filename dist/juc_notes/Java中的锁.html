<!DOCTYPE html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html"><meta property="og:title" content="Java 中的锁"><meta property="og:description" content="记录 Java 中的各种 "锁" 事儿。"><meta property="og:type" content="article"><meta property="og:image" content="https://mister-hope.github.io/my-docs/"><meta property="og:locale" content="en-US"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="Java 中的锁"><meta property="article:author" content="Jimmy"><meta property="article:tag" content="并发"><meta property="article:published_time" content="2023-07-16T00:00:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java 中的锁","image":["https://mister-hope.github.io/my-docs/"],"datePublished":"2023-07-16T00:00:00.000Z","dateModified":null,"author":[{"@type":"Person","name":"Jimmy"}]}</script><title>Java 中的锁</title><meta name="description" content="记录 Java 中的各种 "锁" 事儿。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/my-docs/assets/style-9ab5446d.css" as="style"><link rel="stylesheet" href="/my-docs/assets/style-9ab5446d.css">
    <link rel="modulepreload" href="/my-docs/assets/app-5c2ec4fa.js"><link rel="modulepreload" href="/my-docs/assets/framework-b5ea9e64.js"><link rel="modulepreload" href="/my-docs/assets/Java中的锁.html-148a323f.js"><link rel="modulepreload" href="/my-docs/assets/Java中的锁.html-7ad0a06f.js"><link rel="prefetch" href="/my-docs/assets/intro.html-3c1366e3.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-466673c2.js" as="script"><link rel="prefetch" href="/my-docs/assets/slides.html-32b30afe.js" as="script"><link rel="prefetch" href="/my-docs/assets/disable.html-dadeb134.js" as="script"><link rel="prefetch" href="/my-docs/assets/encrypt.html-f90755a2.js" as="script"><link rel="prefetch" href="/my-docs/assets/markdown.html-4ba53583.js" as="script"><link rel="prefetch" href="/my-docs/assets/page.html-e6abe24e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-1a6abd13.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java_collection.html-5255e6fe.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-cfabd979.js" as="script"><link rel="prefetch" href="/my-docs/assets/deploy_Vuepress.html-8ed0f69a.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java_basic.html-994b1418.js" as="script"><link rel="prefetch" href="/my-docs/assets/notes.html-e8000a77.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC02_LockSupport与中断.html-e7735e6b.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC03Java内存模型JMM.html-0e5cca6b.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC04_CAS.html-fe8da747.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC05_线程池与并发工具.html-b25c0108.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC06_ThreadLocal.html-715c33e9.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-58d38f80.js" as="script"><link rel="prefetch" href="/my-docs/assets/docker中安装redis.html-2e049d2d.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java中的锁.html-75dadfd2.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC02_LockSupport与中断.html-b6b59ff3.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC03Java内存模型JMM.html-6be95cec.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC04_CAS.html-3d2f7652.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC05_线程池与并发工具.html-d309384d.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC06_ThreadLocal.html-2952a12b.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-49c2c5fb.js" as="script"><link rel="prefetch" href="/my-docs/assets/404.html-faf953b6.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-cc4e1394.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-bfc5bb8e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-238c490d.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-4bb66cea.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-078ca550.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-94a2cc5b.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-45950628.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7d321ad5.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-d8bd306e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-eee533f5.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-13963d5a.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-82f3145c.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7bfaa3a3.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7ccfc88f.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-bd09ce65.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-242f3641.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-e2f00287.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-e08e3d6d.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-5a95a274.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-b93fa51f.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-ea97c984.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-b7a75456.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-4e12ad1c.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-39953899.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-f15d0f34.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-34bf2dd6.js" as="script"><link rel="prefetch" href="/my-docs/assets/intro.html-88bbbba3.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-f6fd53c8.js" as="script"><link rel="prefetch" href="/my-docs/assets/slides.html-7d6ea186.js" as="script"><link rel="prefetch" href="/my-docs/assets/disable.html-66a5c74b.js" as="script"><link rel="prefetch" href="/my-docs/assets/encrypt.html-3033137a.js" as="script"><link rel="prefetch" href="/my-docs/assets/markdown.html-04645215.js" as="script"><link rel="prefetch" href="/my-docs/assets/page.html-8678032e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-00448ff8.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java_collection.html-95e4e0b1.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-ad4dbd5c.js" as="script"><link rel="prefetch" href="/my-docs/assets/deploy_Vuepress.html-bddc4d8a.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java_basic.html-d9f56b68.js" as="script"><link rel="prefetch" href="/my-docs/assets/notes.html-453c6c52.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC02_LockSupport与中断.html-7dc61327.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC03Java内存模型JMM.html-427ff2c1.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC04_CAS.html-86ef9068.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC05_线程池与并发工具.html-ce80f47b.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC06_ThreadLocal.html-78509b3c.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-d4a810a8.js" as="script"><link rel="prefetch" href="/my-docs/assets/docker中安装redis.html-5c758f5b.js" as="script"><link rel="prefetch" href="/my-docs/assets/Java中的锁.html-31c7920d.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC02_LockSupport与中断.html-91a0ba4e.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC03Java内存模型JMM.html-13a232e5.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC04_CAS.html-ebbab916.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC05_线程池与并发工具.html-7d819064.js" as="script"><link rel="prefetch" href="/my-docs/assets/JUC06_ThreadLocal.html-dd4236f7.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-9e123180.js" as="script"><link rel="prefetch" href="/my-docs/assets/404.html-efcbdfb8.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-91822548.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-4f9a4b5f.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-11b87b78.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-b93c98f4.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-980af55e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-e82c4191.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-ca4faf6e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-025251c7.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-a36273be.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-64389379.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-da90ef68.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-d80f1d2d.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7c752282.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-a3cf3b28.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-9a262995.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-28bf1937.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-c20b48b5.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-616a6c28.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-5551fcaa.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7a0739b7.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-ff2ab13e.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-f69eb88c.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-c8e4cb15.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-7a26a869.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-dbf81064.js" as="script"><link rel="prefetch" href="/my-docs/assets/index.html-6ee8b06d.js" as="script"><link rel="prefetch" href="/my-docs/assets/giscus-9b97f17f.js" as="script"><link rel="prefetch" href="/my-docs/assets/auto-ba5ecab5.js" as="script"><link rel="prefetch" href="/my-docs/assets/index-8764208e.js" as="script"><link rel="prefetch" href="/my-docs/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/my-docs/assets/mermaid.core-56228b1e.js" as="script"><link rel="prefetch" href="/my-docs/assets/highlight.esm-a794bb63.js" as="script"><link rel="prefetch" href="/my-docs/assets/markdown.esm-d92a2fc9.js" as="script"><link rel="prefetch" href="/my-docs/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/my-docs/assets/notes.esm-224f94d9.js" as="script"><link rel="prefetch" href="/my-docs/assets/reveal.esm-e5069ce0.js" as="script"><link rel="prefetch" href="/my-docs/assets/search.esm-2c3fba7d.js" as="script"><link rel="prefetch" href="/my-docs/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/my-docs/assets/VuePlayground-f72ed70e.js" as="script"><link rel="prefetch" href="/my-docs/assets/photoswipe.esm-6e6cbe40.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/my-docs/" class="brand"><img class="logo" src="/my-docs/logo.svg" alt><!----><!----></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="技术文章"><span class="title"><span class="font-icon icon iconfont icon-java" style=""></span>技术文章</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/my-docs/juc_notes" class="nav-link active" aria-label="JUC"><span class="font-icon icon iconfont icon-java" style=""></span>JUC<!----></a></li><li class="dropdown-item"><a href="/my-docs/java" class="nav-link" aria-label="java"><span class="font-icon icon iconfont icon-java" style=""></span>java<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="生活"><span class="title"><span class="font-icon icon iconfont icon-java" style=""></span>生活</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/my-docs/juc_notes" class="nav-link active" aria-label="JUC"><span class="font-icon icon iconfont icon-java" style=""></span>JUC<!----></a></li><li class="dropdown-item"><a href="/my-docs/java" class="nav-link" aria-label="java"><span class="font-icon icon iconfont icon-java" style=""></span>java<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-database" style=""></span><span class="title">数据库</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-spring" style=""></span><span class="title">spring</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">计算机基础</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-other" style=""></span><span class="title">other</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-demo" style=""></span><span class="title">demo</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-page" style=""></span>Java 中的锁</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Jimmy</span></span><span property="author" content="Jimmy"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-16T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 24 min</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category6 clickable" role="navigation">java</span><span class="page-category-item category7 clickable" role="navigation">JUC</span><meta property="articleSection" content="java,JUC"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag6 clickable" role="navigation">并发</span><meta property="keywords" content="并发"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<button class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html#_1、synchronized" class="router-link-active router-link-exact-active toc-link level1">1、synchronized</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html#_2、对象头与锁-monitor" class="router-link-active router-link-exact-active toc-link level1">2、对象头与锁（Monitor）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html#_3、jit编译器对锁的优化" class="router-link-active router-link-exact-active toc-link level1">3、JIT编译器对锁的优化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-锁的活跃性问题" class="router-link-active router-link-exact-active toc-link level1">4.锁的活跃性问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/my-docs/juc_notes/Java%E4%B8%AD%E7%9A%84%E9%94%81.html#参考" class="router-link-active router-link-exact-active toc-link level1">参考</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>记录 <code>Java</code> 中的各种 &quot;锁&quot; 事儿。</p><!-- more --><h1 id="_1、synchronized" tabindex="-1"><a class="header-anchor" href="#_1、synchronized" aria-hidden="true">#</a> 1、synchronized</h1><h2 id="_1-1-synchronized的解释" tabindex="-1"><a class="header-anchor" href="#_1-1-synchronized的解释" aria-hidden="true">#</a> 1.1 synchronized的解释</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span><span class="token punctuation">(</span>锁对象<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 临界区</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>synchronized：对象锁，保证了临界区内代码的原子性</strong>，采用互斥的方式让同一时刻至多只有一个线程能持有对象锁，其它线程获取这个对象锁时会阻塞，保证拥有锁的线程可以安全的执行临界区内的代码，不用担心线程上下文切换</p><p>互斥和同步都可以采用 synchronized 关键字来完成，区别：</p><ul><li>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</li><li>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</li></ul><p>性能：</p><ul><li>线程安全，性能差</li><li>线程不安全性能好，假如开发中不会存在多线程安全问题，建议使用线程不安全的设计类</li></ul><h2 id="_1-2-synchronized的用法" tabindex="-1"><a class="header-anchor" href="#_1-2-synchronized的用法" aria-hidden="true">#</a> 1.2 synchronized的用法</h2><ol><li>同步代码块+对象锁</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">IncreaseAndDecrease</span> inde <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncreaseAndDecrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>inde<span class="token punctuation">)</span><span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>同步方法+对象锁</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 等价于：</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>同步静态方法+对象锁</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 等价于：</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">synchronized</span><span class="token punctuation">(</span>当前类<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="用法小总结" tabindex="-1"><a class="header-anchor" href="#用法小总结" aria-hidden="true">#</a> 用法小总结</h3><ol><li>非静态方法的默认锁为 this，静态方法的锁默认为Class实例。</li><li>在某一个时刻内，之能有一个线程持有锁，无论几个方法。</li><li>更多案例可以参考：<a href="https://blog.csdn.net/qq_43521756/article/details/107401896" target="_blank" rel="noopener noreferrer">线程八锁<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><h2 id="_1-3-线程安全分析" tabindex="-1"><a class="header-anchor" href="#_1-3-线程安全分析" aria-hidden="true">#</a> 1.3 线程安全分析</h2><p>分析程序是否有线程安全问题，主要就是看是否有<strong>多个线程共享同一个资源变量</strong>。 <strong>例子1</strong>：下面的例子中，两个线程操作的都是局部变量，不存在共享问题，所以没有线程安全问题。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">chapter02</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadSafeAnalysis</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ThreadSafe</span> threadSafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                threadSafe<span class="token punctuation">.</span><span class="token function">method01</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;Thread 01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ThreadSafe</span> threadSafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                threadSafe<span class="token punctuation">.</span><span class="token function">method01</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;Thread 02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadSafe</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method01</span><span class="token punctuation">(</span><span class="token keyword">int</span> loopnumber<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// list 为局部变量故而，每个线程调用method01方法都会创建一个list对象</span>
        <span class="token comment">// 所以不会有线程安全问题</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loopnumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">method2</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method3</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例子2：将上面例子中的 <code>method3</code> 修改如下。这样就会出现两个线程同时访问 list（【Thread 01 与 Thread 03】或者【Thread 02 与 Thread 03】）。这样就会出现线程安全问题。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;Thread 03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程安全的设计建议" tabindex="-1"><a class="header-anchor" href="#线程安全的设计建议" aria-hidden="true">#</a> 线程安全的设计建议</h4><ol><li>设计程序时，不该暴露给外部的方法一定要私有化，防止子类重写。</li><li>暴露给外部的方法，考虑是否需要final，防止子类重写。</li><li>当前设计的类，是否需要被继承，如果不需要可直接final修饰来保证线程安全。</li></ol><h2 id="_1-4-常见的线程安全类" tabindex="-1"><a class="header-anchor" href="#_1-4-常见的线程安全类" aria-hidden="true">#</a> 1.4 常见的线程安全类</h2><ul><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>JUC包下的类</li></ul><h1 id="_2、对象头与锁-monitor" tabindex="-1"><a class="header-anchor" href="#_2、对象头与锁-monitor" aria-hidden="true">#</a> 2、对象头与锁（Monitor）</h1><p>JVM中对象头的方式有以下两种（以32位JVM为例）：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token class-name">Object</span> <span class="token class-name">Header</span> <span class="token punctuation">(</span><span class="token number">64</span> bits<span class="token punctuation">)</span>                  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token class-name">Mark</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>         <span class="token operator">|</span>    <span class="token class-name">Klass</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token class-name">Klass</span> <span class="token class-name">Word</span>：指向对象所属的类对象。
# 数组对象
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>                                 <span class="token class-name">Object</span> <span class="token class-name">Header</span> <span class="token punctuation">(</span><span class="token number">96</span> bits<span class="token punctuation">)</span>                         <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token class-name">Mark</span> <span class="token class-name">Word</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span>       <span class="token operator">|</span>    <span class="token class-name">Klass</span> <span class="token class-name">Word</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span> <span class="token operator">|</span>  array <span class="token function">length</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span>  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-1-对象头的组成" tabindex="-1"><a class="header-anchor" href="#_2-1-对象头的组成" aria-hidden="true">#</a> 2.1 对象头的组成</h2><h3 id="_2-1-1-mark-word" tabindex="-1"><a class="header-anchor" href="#_2-1-1-mark-word" aria-hidden="true">#</a> 2.1.1 Mark Word</h3><p>这部分主要用来存储对象自身的运行时数据，如 <code>hashcode、gc</code> 分代年龄等。<code>mark word</code> 的位长度为 JVM 的一个 Word 大小，也就是说32位JVM的 Mark word 为32位，64位JVM为64位。为了让一个字大小存储更多的信息，JVM将字的最低两个位设置为标记位，不同标记位下的Mark Word示意如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                  <span class="token class-name">Mark</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>                  <span class="token operator">|</span>       <span class="token class-name">State</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span> hashcode<span class="token operator">:</span><span class="token number">25</span> <span class="token operator">|</span> age<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token operator">:</span><span class="token number">0</span> 		   <span class="token operator">|</span> <span class="token number">01</span> 	<span class="token operator">|</span>       <span class="token class-name">Normal</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>  thread<span class="token operator">:</span><span class="token number">23</span> <span class="token operator">|</span> epoch<span class="token operator">:</span><span class="token number">2</span> <span class="token operator">|</span> age<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">01</span> 	<span class="token operator">|</span>       <span class="token class-name">Biased</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>               ptr_to_lock_record<span class="token operator">:</span><span class="token number">30</span>          <span class="token operator">|</span> <span class="token number">00</span> 	<span class="token operator">|</span> <span class="token class-name">Lightweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>               ptr_to_heavyweight_monitor<span class="token operator">:</span><span class="token number">30</span>  <span class="token operator">|</span> <span class="token number">10</span> 	<span class="token operator">|</span> <span class="token class-name">Heavyweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                              <span class="token operator">|</span> <span class="token number">11</span> 	<span class="token operator">|</span>    <span class="token class-name">Marked</span> <span class="token keyword">for</span> <span class="token constant">GC</span>   <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>biased_lock</strong>：对象是否启用偏向锁标记，只占1个二进制位。为1时表示对象启用偏向锁，为0时表示对象没有偏向锁。</li><li><strong>age</strong>：4位的 Java 对象年龄。在GC中，如果对象在<strong>Survivor</strong>区复制一次，年龄增加1。当对象达到设定的阈值时，将会晋升到老年代。默认情况下，并行GC的年龄阈值为15，并发GC的年龄阈值为6。由于age只有4位，所以最大值为15，这就是 <code>-XX:MaxTenuringThreshold</code> 选项最大值为15的原因。</li><li>identity_hashcode：25位的对象标识Hash码，采用延迟加载技术。调用方法 <code>System.identityHashCode()</code> 计算，并会将结果写到该对象头中。当对象被锁定时，该值会移动到管程 <code>Monitor</code> 中。</li><li>thread：持有偏向锁的线程ID。</li><li>epoch：偏向时间戳。</li><li>ptr_to_lock_record：指向栈中锁记录的指针。</li><li>ptr_to_heavyweight_monitor：指向管程Monitor的指针。</li></ul><h3 id="_2-1-2-从java对象看-mark-word" tabindex="-1"><a class="header-anchor" href="#_2-1-2-从java对象看-mark-word" aria-hidden="true">#</a> 2.1.2 从Java对象看 Mark Word</h3><figure><img src="/my-docs/assets/d9a22a61229c41f5989bc2cf55a819a0-ce91d144.png" alt="markword的结构" tabindex="0" loading="lazy"><figcaption>markword的结构</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/*
    情况一：调用hashcode
    10进制的Hash码：1554874502
	16进制的Hash码：5c ad 80 86
	2进制的Hash码：1011100101011011000000010000110
				01011100101011011000000010000110
      0     4        (object header)                           01 86 80 ad (00000001 10000110 10000000 10101101) (-1384086015)
      4     4        (object header)                           5c 00 00 00 (01011100 00000000 00000000 00000000) (92)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)

    情况二：不调用HashCode
      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        System.out.println(&quot;10进制的Hash码：&quot;+o.hashCode());</span>
<span class="token comment">//        System.out.println(&quot;16进制的Hash码：&quot;+Integer.toHexString(o.hashCode()));</span>
<span class="token comment">//        System.out.println(&quot;2进制的Hash码：&quot;+Integer.toBinaryString(o.hashCode()));</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;无锁状态的对象头：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayou</span>	t<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>情况二：不调用HashCode</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
第一行  <span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
第二行  <span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
第三行  <span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           e5 <span class="token number">01</span> <span class="token number">00</span> f8 <span class="token punctuation">(</span><span class="token number">11100101</span> <span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">11111000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">134217243</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先从第二行的最后一个字节开始，往前逐个字节的排列，可以得到如下二进制序列：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>00000000 00000000 00000000 0 0000000 00000000 00000000 00000000         0 		   0000       0    		   01
|---------unused（25位）----| |------hashcode（31位）------------| |-unused（1位）-| |-age-| |-偏向锁位置-| |-锁标志位置-|
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>情况一：调用hashcode方法</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token number">10</span>进制的<span class="token class-name">Hash</span>码：<span class="token number">1554874502</span>
	<span class="token number">16</span>进制的<span class="token class-name">Hash</span>码：<span class="token number">5</span>c ad <span class="token number">80</span> <span class="token number">86</span>
	<span class="token number">2</span>进制的<span class="token class-name">Hash</span>码：<span class="token number">1011100101011011000000010000110</span>
				 <span class="token number">1011100101011011000000010000110</span>
      <span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">01</span> <span class="token number">86</span> <span class="token number">80</span> ad <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">10000110</span> <span class="token number">10000000</span> <span class="token number">10101101</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1384086015</span><span class="token punctuation">)</span>
      <span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">5</span>c <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">01011100</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">)</span>
      <span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           e5 <span class="token number">01</span> <span class="token number">00</span> f8 <span class="token punctuation">(</span><span class="token number">11100101</span> <span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">11111000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">134217243</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先从第二行的最后一个字节开始，往前逐个字节的排列，可以得到如下二进制序列：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">01011100</span> <span class="token number">10101101</span> <span class="token number">10000000</span> <span class="token number">10000110</span> <span class="token number">00000001</span>
对其进行划分：
<span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">0</span> <span class="token number">1011100</span> <span class="token number">10101101</span> <span class="token number">10000000</span> <span class="token number">10000110</span>        <span class="token number">0</span>          <span class="token number">0000</span>        <span class="token number">0</span>            <span class="token number">01</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>unused（<span class="token number">25</span>位）<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>hashcode（<span class="token number">31</span>位）<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>unused（<span class="token number">1</span>位）<span class="token operator">-</span><span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>age<span class="token operator">-</span><span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>偏向锁位置<span class="token operator">-</span><span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>锁标志位置<span class="token operator">-</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加锁之后的markword有什么变化，在2.3节进行分析。</p><h2 id="_2-2-monitor" tabindex="-1"><a class="header-anchor" href="#_2-2-monitor" aria-hidden="true">#</a> 2.2 Monitor</h2><p>Monitor 被翻译为监视器或管程。在HotSpot虚拟机中，Monitor是基于C++的<code>ObjectMonitor</code>类实现的，其主要成员包括：</p><ul><li>_owner：指向持有ObjectMonitor对象的线程</li><li>_WaitSet：存放处于wait状态的线程队列，即调用wait()方法的线程</li><li>_EntryList：存放处于等待锁block状态的线程队列</li><li>_count：约为_WaitSet 和 _EntryList 的节点数之和</li><li>_cxq: 多个线程争抢锁，会先存入这个单向链表</li><li>_recursions: 记录重入次数</li></ul><p>每个 Java 对象都可以关联一个 Monitor 对象，Monitor 也是 class，其<strong>实例存储在堆中</strong>，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的 Mark Word 中就被设置指向 Monitor 对象的指针，这就是重量级锁。</p><h3 id="_2-2-1-objectmonitor的工作流程" tabindex="-1"><a class="header-anchor" href="#_2-2-1-objectmonitor的工作流程" aria-hidden="true">#</a> 2.2.1 ObjectMonitor的工作流程</h3><figure><img src="/my-docs/assets/b2007030488f468ea9d71cec734815cd-aaf6456a.png" alt="Monitor" tabindex="0" loading="lazy"><figcaption>Monitor</figcaption></figure><ul><li>当多个线程同时访问一段同步代码时，首先会进入 <code>_EntryList </code> 队列中。</li><li>当某个线程获取到对象的 Monitor 后进入临界区域，并把 Monitor 中的 <code>_owner</code> 变量指向<strong>同步对象</strong>，同时Monitor中的计数器 _count 加1。即获得对象锁。</li><li>若持有Monitor的线程调用 wait() 方法，将释放当前持有的Monitor，_owner变量恢复为null，_count自减1，同时该线程进入 _WaitSet 集合中等待被唤醒。</li><li>在_WaitSet 集合中的线程会被再次放到_EntryList 队列中，重新竞争获取锁。</li><li>若当前线程执行完毕也将释放Monitor并复位变量的值，以便其他线程进入获取锁。 <img src="/my-docs/assets/5b3a568e53a94f9ba9526379515fec30-f2904f1c.png" alt="在这里插入图片描述" loading="lazy"></li></ul><blockquote><p>注意：</p><ol><li>synchronized 必须是进入同一个对象的 Monitor 才有上述的效</li><li>不加 synchronized 的对象不会关联监视器，不遵从以上规则</li></ol></blockquote><h3 id="_2-2-2-从字节码的角度理解加锁原理" tabindex="-1"><a class="header-anchor" href="#_2-2-2-从字节码的角度理解加锁原理" aria-hidden="true">#</a> 2.2.2 从字节码的角度理解加锁原理</h3><ul><li>情况一：同步代码块</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">0</span><span class="token operator">:</span> 	<span class="token keyword">new</span>				#<span class="token number">2</span>		<span class="token comment">// new Object</span>
<span class="token number">3</span><span class="token operator">:</span> 	dup						<span class="token comment">// 复制一份</span>
<span class="token number">4</span><span class="token operator">:</span> 	invokespecial 	#<span class="token number">1</span> 		<span class="token comment">// 初始化Object对象</span>
<span class="token number">7</span><span class="token operator">:</span> 	astore_1 				<span class="token comment">// 将lock引用存入本地变量表1的位置</span>
<span class="token number">8</span><span class="token operator">:</span> 	aload_1					<span class="token comment">// 加载lock （synchronized开始）</span>
<span class="token number">9</span><span class="token operator">:</span> 	dup						<span class="token comment">// 一份用来初始化，一份用来引用</span>
<span class="token number">10</span><span class="token operator">:</span> astore_2 				<span class="token comment">// 将复制的lock对象存入本地变量表2的位置</span>
<span class="token number">11</span><span class="token operator">:</span> monitorenter 			<span class="token comment">// 【将 lock对象 MarkWord 置为 Monitor 指针】</span>
<span class="token number">12</span><span class="token operator">:</span> getstatic 		#<span class="token number">3</span>		<span class="token comment">// System.out</span>
<span class="token number">15</span><span class="token operator">:</span> ldc 			#<span class="token number">4</span>		<span class="token comment">// &quot;ok&quot;</span>
<span class="token number">17</span><span class="token operator">:</span> invokevirtual 	#<span class="token number">5</span> 		<span class="token comment">// invokevirtual println:(Ljava/lang/String;)V</span>
<span class="token number">20</span><span class="token operator">:</span> aload_2 				<span class="token comment">// slot 2(lock引用)</span>
<span class="token number">21</span><span class="token operator">:</span> monitorexit 			<span class="token comment">// 【将 lock对象 MarkWord 重置, 唤醒 EntryList】</span>
<span class="token number">22</span><span class="token operator">:</span> <span class="token keyword">goto</span> <span class="token number">30</span>
<span class="token comment">// 下面是同步代码块出现异常后的操作</span>
<span class="token number">25</span><span class="token operator">:</span> astore_3 				<span class="token comment">//异常对象存入本地变量表3的位置 any -&gt; slot 3</span>
<span class="token number">26</span><span class="token operator">:</span> aload_2 				<span class="token comment">// slot 2(lock引用)</span>
<span class="token number">27</span><span class="token operator">:</span> monitorexit 			<span class="token comment">// 【将 lock对象 MarkWord 重置, 唤醒 EntryList】</span>
<span class="token number">28</span><span class="token operator">:</span> aload_3 				<span class="token comment">// 加载异常</span>
<span class="token number">29</span><span class="token operator">:</span> athrow					<span class="token comment">// 将异常抛出</span>
<span class="token number">30</span><span class="token operator">:</span> <span class="token keyword">return</span>
<span class="token class-name">Exception</span> table<span class="token operator">:</span>
    from <span class="token keyword">to</span> <span class="token namespace">target</span> type
      <span class="token number">12</span> <span class="token number">22</span> <span class="token number">25</span> 		any
      <span class="token number">25</span> <span class="token number">28</span> <span class="token number">25</span> 		any
<span class="token class-name">LineNumberTable</span><span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">LocalVariableTable</span><span class="token operator">:</span>
    <span class="token class-name">Start</span> <span class="token class-name">Length</span> <span class="token class-name">Slot</span> <span class="token class-name">Name</span> <span class="token class-name">Signature</span>
    	<span class="token number">0</span> 	<span class="token number">31</span> 		<span class="token number">0</span> args <span class="token punctuation">[</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span>
    	<span class="token number">8</span> 	<span class="token number">23</span> 		<span class="token number">1</span> lock <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Object</span><span class="token punctuation">;</span>                    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>解释： 1 通过异常 <strong>try-catch 机制</strong>，确保一定会被解锁 2 方法级别的 synchronized 不会在字节码指令中有所体现</p></blockquote><ul><li>情况二：synchronized 普通同步方法</li></ul><p>调用指令将会检查方法的<code>ACC_SYNCHRONIZED</code>访问标志是否被设置，如果设置了，执行线程会将现持有monitor锁，然后再执行该方法，最后在方法完成（无论是否正常结束）时释放monitor。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>code<span class="token operator">:</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;分析非静态方法加锁后的字节码信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Bytecode</span><span class="token operator">:</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_SYNCHRONIZED</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">3</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">6</span>                  <span class="token comment">// String 分析非静态方法加锁后的字节码信息</span>
         <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
         <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">LineNumberTable</span><span class="token operator">:</span>
        line <span class="token number">13</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">14</span><span class="token operator">:</span> <span class="token number">8</span>
      <span class="token class-name">LocalVariableTable</span><span class="token operator">:</span>
        <span class="token class-name">Start</span>  <span class="token class-name">Length</span>  <span class="token class-name">Slot</span>  <span class="token class-name">Name</span>   <span class="token class-name">Signature</span>
            <span class="token number">0</span>       <span class="token number">9</span>     <span class="token number">0</span>  <span class="token keyword">this</span>   <span class="token class-name">Lchapter02</span><span class="token operator">/</span><span class="token class-name">ByteCodeAnalysis</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>情况三：synchronized 静态同步方法</li></ul><p><code>ACC_STATIC、ACC_SYNCHRONIZED</code>访问标志区分该方法是否是静态同步方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_STATIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_SYNCHRONIZED</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-3-为什么每个对象都可以作为一个锁" tabindex="-1"><a class="header-anchor" href="#_2-2-3-为什么每个对象都可以作为一个锁" aria-hidden="true">#</a> 2.2.3 为什么每个对象都可以作为一个锁？</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>在<code>JVM</code>中每个Java对象都会对应一个C++实现的 <code>ObjectMonitor</code>。</p></li><li><p>当对程序进行加锁时，<code>lock</code> 对象的对象头中的<code>markword</code>被设置为指向 <code>ObjectMonitor</code>的指针（重量锁的情况，其他锁有些许区别）。</p></li><li><p>当线程抢到锁后，<code>ObjectMonitor</code>对象中的<code>owner</code>属性会被设置为当前线程对象，代表当前线程已经持有锁。<code>ObjectMonitor</code>对象会被锁定，其他线程无法获得锁。</p></li><li><p>当前线程释放锁，<code>owner</code>设置为 <code>Null</code>，并唤醒其他线程进行争枪锁。</p></li></ol><h2 id="_2-3-synchronized-的升级过程" tabindex="-1"><a class="header-anchor" href="#_2-3-synchronized-的升级过程" aria-hidden="true">#</a> 2.3 synchronized 的升级过程</h2><p>在 Java 早期版本中，<code>synchronized</code>属于<strong>重量级锁</strong>，效率低下。为什么呢？因为监视器锁（monitor）是依赖于底层的操作系统来实现的，Java 的线程是映射到操作系统的原生线程之上的。如果要挂起或者唤醒一个线程，都需要操作系统帮忙完成，而操作系统实现线程之间的切换时需要从<strong>用户态转换到内核态</strong>，这个状态之间的转换需要相对比较长的时间，时间成本相对较高。</p><p>庆幸的是在 Java 6 之后 Java 官方对从 JVM 层面对 <code>synchronized</code> 较大优化，所以现在的 <code>synchronized</code> 锁效率也优化得很不错了。JDK1.6 对锁的实现引入了大量的优化，如自旋锁、适应性自旋锁、锁消除、锁粗化、偏向锁、轻量级锁等技术来减少锁操作的开销。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>无锁（CAS） -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁	// 随着竞争的增加，只能锁升级，不能降级
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>Synchronized</code>用的锁是存在<code>Java</code>对象头里的<code>MarkWord</code>中，锁升级功能主要依赖<code>MarkWord</code>中锁标志位和释放偏向锁标志位。</p><figure><img src="/my-docs/assets/d9a22a61229c41f5989bc2cf55a819a0-ce91d144.png" alt="markword的结构" tabindex="0" loading="lazy"><figcaption>markword的结构</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                  <span class="token class-name">Mark</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>                  <span class="token operator">|</span>       <span class="token class-name">State</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span> hashcode<span class="token operator">:</span><span class="token number">25</span> <span class="token operator">|</span> age<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token operator">:</span><span class="token number">0</span> 		     <span class="token operator">|</span> <span class="token number">01</span> 	<span class="token operator">|</span>       <span class="token class-name">Normal</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>  threadID<span class="token operator">:</span><span class="token number">23</span> <span class="token operator">|</span> epoch<span class="token operator">:</span><span class="token number">2</span> <span class="token operator">|</span> age<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">01</span> 	<span class="token operator">|</span>       <span class="token class-name">Biased</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>               ptr_to_lock_record<span class="token operator">:</span><span class="token number">30</span>            <span class="token operator">|</span> <span class="token number">00</span> 	<span class="token operator">|</span> <span class="token class-name">Lightweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>               ptr_to_heavyweight_monitor<span class="token operator">:</span><span class="token number">30</span>    <span class="token operator">|</span> <span class="token number">10</span> 	<span class="token operator">|</span> <span class="token class-name">Heavyweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                                <span class="token operator">|</span> <span class="token number">11</span> 	<span class="token operator">|</span>    <span class="token class-name">Marked</span> <span class="token keyword">for</span> <span class="token constant">GC</span>   <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>偏向锁（Biased）：<code>MarkWord</code>存储的是偏向的线程ID</li><li>轻量锁：<code>MarkWord</code>存储的是指向线程栈中<code>Lock Record</code>的指针</li><li>重量锁：<code>MarkWord</code>存储的是指向堆中的<code>monitor</code>对象（系统互斥量指针）</li></ul><h3 id="_2-3-0-无锁-001" tabindex="-1"><a class="header-anchor" href="#_2-3-0-无锁-001" aria-hidden="true">#</a> 2.3.0 无锁（001）</h3><p>参见：<strong>2.1.2 从Java对象看 Mark Word</strong></p><h3 id="_2-3-1-偏向锁-101" tabindex="-1"><a class="header-anchor" href="#_2-3-1-偏向锁-101" aria-hidden="true">#</a> 2.3.1 偏向锁（101）</h3><p>偏向锁的思想是偏向于让<strong>第一个获取锁对象的线程</strong>，这个线程之后<strong>重新获取该锁不再需要同步</strong>操作：</p><ul><li>当锁对象第一次被线程获得的时候进入偏向状态，标记为 101，同时<strong>使用 CAS 操作将线程 ID 记录到 Mark Word</strong>。如果 CAS 操作成功，这个线程以后进入这个锁相关的同步块，查看这个线程 ID 是自己的就表示没有竞争，就不需要再进行任何同步操作</li><li>当有另外一个线程去尝试获取这个锁对象时，偏向状态就宣告结束，此时撤销偏向（Revoke Bias）后恢复到未锁定或轻量级锁状态</li></ul><p>偏向锁：<strong>单线程竞争</strong>，当线程A第一次竞争到锁时，通过修改<code>MarkWord</code>中的偏向线程ID、偏向模式。<strong>如果不存在其他线程竞争，那么持有偏向锁的线程将永远不需要进行同步</strong>。</p><p>理论落地：</p><figure><img src="/my-docs/assets/1681451836192-5ae30f1e-085d-4c2b-aa8c-1bd47f199116-e9e6b47a.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>技术实现：</p><figure><img src="/my-docs/assets/1681451914425-01aa0721-8f56-4413-a1db-5092fcbfdf06-7725c34a.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>有关偏向锁的命令：</p><figure><img src="/my-docs/assets/1681452242110-e3b8e768-acfb-4f43-9a50-8699e9952ece-62fc2a9e.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>案例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">BiasedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
         * 这里偏向锁在JDK6以上默认开启，开启后程序启动4秒后才会被激活，可以通过JVM参数来关闭延迟
         * 开启偏向锁：     -XX:+UseBiasedLocking
         * 关闭偏向锁的延迟  -XX:BiasedLockingStartupDelay=0
    */</span>
    <span class="token comment">//        try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); }</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p><figure><img src="/my-docs/assets/image-20230628134138026-7aed4271.png" alt="image-20230628134138026" tabindex="0" loading="lazy"><figcaption>image-20230628134138026</figcaption></figure><p>通过如下命令，可以查看<code>JVM</code>相关参数的默认值。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-XX:+PrintFlagsInitial</span> <span class="token operator">|</span> <span class="token function">grep</span> BiasedLock*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="/my-docs/assets/image-20230628135649096-2034af15.png" alt="image-20230628135649096" tabindex="0" loading="lazy"><figcaption>image-20230628135649096</figcaption></figure><blockquote><p>注意：</p><p>由于偏向锁启动有延迟，故而不加入 <code>-XX:BiasedLockingStartupDelay=0</code> 参数或者 <code>TimeUnit.SECONDS.sleep(5);</code>。上述代码会直接进入轻量级锁的状态**（锁标志位：00）<strong>，而不是偏向锁</strong>（偏向锁位+锁标志位：101）**。</p><p>由于维护成本过高，在<strong>JDK15</strong>以后会逐步废弃偏向锁。</p></blockquote><h3 id="_2-3-2-轻量级锁-00" tabindex="-1"><a class="header-anchor" href="#_2-3-2-轻量级锁-00" aria-hidden="true">#</a> 2.3.2 轻量级锁（00）</h3><p>概念：多线程竞争，但是任意时候<strong>最多只有一个线程竞争</strong>，即<strong>不存在锁竞争太激烈的情况</strong>，也就没有线程阻塞。</p><p>主要作用：有线程来参与锁的竞争，但是获取锁的冲突时间极短，本质是自旋锁CAS。</p><figure><img src="/my-docs/assets/1681454510407-cde9df3c-e7ed-415f-a459-76f64160035f-d2d0bc1f.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>轻量锁的获取：</p><figure><img src="/my-docs/assets/1681454665890-db296f20-69b8-4bd8-8538-0197584c61e5-74b7856f.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="轻量级锁的加锁与释放" tabindex="-1"><a class="header-anchor" href="#轻量级锁的加锁与释放" aria-hidden="true">#</a> 轻量级锁的加锁与释放</h4><p><strong>轻量级锁的加锁</strong></p><p><code>JVM</code>会为每个线程在当前线程的栈帧中创建用于存储锁记录的空间，官方称为<code>Displaced Mark Word</code>。若一个线程获得锁时发现是轻量级锁，会把锁的<code>MarkWord</code>复制到自己的<code>Displaced Mark Word</code>里面。然后线程尝试用<code>CAS</code>将锁的<code>MarkWord</code>替换为<strong>指向锁记录的指针</strong>。如果成功，当前线程获得锁，如果失败，表示Mark Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前线程就尝试使用自旋来获取锁。</p><p>自旋CAS：不断尝试去获取锁，能不升级就不升级，尽量不要阻寨。</p><p><strong>轻量级锁的释放</strong></p><p>在释放锁时，当前线程会使用<code>CAS</code>操作将<code>Displaced Mark Word</code>的内容复制回锁的Mark Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为自旋多次导致轻量级锁升级成了重量级锁，那么<code>CAS</code>操作会失败，此时会释放锁并唤醒被阻寨的线程。</p><h4 id="自旋锁的次数" tabindex="-1"><a class="header-anchor" href="#自旋锁的次数" aria-hidden="true">#</a> 自旋锁的次数</h4><p><strong>java6之前</strong></p><figure><img src="/my-docs/assets/019bb3b645bb406a89f7469cab952f07-39554365.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><p><strong>java6之后</strong></p><p>自适应自选锁：线程如果自旋成功了，那下次自旋的最大次数会增加，因为<code>JVM</code>认为既然上次成功了，那么这一次也很大概率会成功。如果很少会自旋成功，那么下次会减少自旋的次数甚至不自旋，避免CPU空转。</p><h4 id="轻量锁和偏向锁的区别和不同" tabindex="-1"><a class="header-anchor" href="#轻量锁和偏向锁的区别和不同" aria-hidden="true">#</a> 轻量锁和偏向锁的区别和不同</h4><ul><li>争夺轻量级锁失败时，自旋尝试抢占锁</li><li>轻量级锁每次退出同步块都需要释放锁，而偏向锁是在竞争发生时才释放锁</li></ul><h3 id="_2-3-3-重量级锁-10" tabindex="-1"><a class="header-anchor" href="#_2-3-3-重量级锁-10" aria-hidden="true">#</a> 2.3.3 重量级锁（10）</h3><figure><img src="/my-docs/assets/896a934c809740a68c5e18ec7374f100-cd3f720d.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><p>有大量的线程参与锁的竞争，冲突性很高。</p><p>Java中synchronized的重量级锁，是基于进入和退出<code>Monitor</code>对象实现的。在编译时会将同步块的开始位置插入<code>monitorenter</code>指令，在结束位置插入<code>monitorexit</code>指令。</p><p>当线程执行到<code>monitorenter</code>指令时，会尝试获取对象所对应的<code>Monitor</code>所有权，如果获取到了，即获取到了锁，会在<code>Monitor</code>的<code>owner</code>中存放<strong>当前线程的id</strong>，这样它将处于锁定状态，除非退出同步块，否则其他线程无法获取到这个<code>Monitor</code>。</p><h3 id="_2-3-4-小总结-面试中的高频考点" tabindex="-1"><a class="header-anchor" href="#_2-3-4-小总结-面试中的高频考点" aria-hidden="true">#</a> 2.3.4 小总结-面试中的高频考点</h3><p><strong>锁升级发生后，hashcode去哪啦</strong></p><p>锁升级为轻量级或重量级锁后，Mark Word中保存的分别是线程栈帧里的锁记录指针和重量级锁指针，己经没有位置再保存哈希码，GC年龄了，那么这些信息被移动到哪里去了呢？</p><p>下面描述来源于：《深度理解Java虚拟机》第三版。</p><figure><img src="/my-docs/assets/image-20230628145143475-c83fe108.png" alt="image-20230628145143475" tabindex="0" loading="lazy"><figcaption>image-20230628145143475</figcaption></figure><blockquote><p>计算过哈希的对象，无法在进入偏向锁状态。</p><p>处于偏向锁的对象，当需要计算哈希时，该对象的偏向状态会被撤销，升级为重量级锁。而重量级锁对应<code>ObjectMonitor</code>对象有字段记录锁对象的<code>Markword</code> ，自然也就可以存储<code>hashcode</code></p></blockquote><p>代码验证：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">BiasedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
         * 这里偏向锁在JDK6以上默认开启，开启后程序启动几秒后才会被激活，可以通过JVM参数来关闭延迟
         * 开启偏向锁：     -XX:+UseBiasedLocking
         * 关闭偏向锁的延迟  -XX:BiasedLockingStartupDelay=0
         */</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;不进行hash计算&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//        情况一：进行hashcode计算，对象无法进入偏向锁状态。</span>
    <span class="token class-name">Object</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;情况一：没有取得锁，进行hashcode计算，对象无法进入偏向锁状态。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算hashcode</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 因为o2计算过hashcode，故而会直接进入轻量级锁。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
         情况二：取得偏向锁后，进行hashcode计算。对象会升级为重量级锁。
         */</span>
    <span class="token class-name">Object</span> o3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;情况二：取得偏向锁后，进行hashcode计算。对象会升级为重量级锁。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o3<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 因为o2计算过hashcode，故而会直接进入轻量级锁。</span>
        <span class="token comment">//            计算hash之前</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;计算hash之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o3<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;计算hash之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：通过锁标记位置，可以发现锁的变化过程。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>开始
不进行hash计算
java.lang.Object object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 c8 88 00 (00000101 11001000 10001000 00000000) (8964101)
      4     4        (object header)                           dd 01 00 00 (11011101 00000001 00000000 00000000) (477)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

情况一：没有取得锁，进行hashcode计算，对象无法进入偏向锁状态。
1724731843
java.lang.Object object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           e8 f6 cf 38 (11101000 11110110 11001111 00111000) (953153256)
      4     4        (object header)                           cd 00 00 00 (11001101 00000000 00000000 00000000) (205)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

情况二：取得偏向锁后，进行hashcode计算。对象会升级为重量级锁。
计算hash之前
java.lang.Object object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 c8 88 00 (00000101 11001000 10001000 00000000) (8964101)
      4     4        (object header)                           dd 01 00 00 (11011101 00000001 00000000 00000000) (477)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

1305193908
计算hash之后
java.lang.Object object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           da fc 78 24 (11011010 11111100 01111000 00100100) (611908826)
      4     4        (object header)                           dd 01 00 00 (11011101 00000001 00000000 00000000) (477)
      8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

结束
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-4-公平锁与非公平锁" tabindex="-1"><a class="header-anchor" href="#_2-4-公平锁与非公平锁" aria-hidden="true">#</a> 2.4 公平锁与非公平锁</h2><ul><li>公平锁：是指多个线程按照申请锁的顺序来获取锁，这里类似于排队买票，先来的人先买，后来的人再队尾排着，这是公平的。例如：<code>Lock lock = new ReentrantLock(true)</code> 表示公平锁，先来先得。</li><li>非公平锁：是指多个线程获取锁的顺序并不是按照申请的顺序，有可能后申请的线程比先申请的线程优先获取锁，在高并发环境下，有可能造成优先级反转或者饥饿的状态（某个线程一直得不到锁）。例如：<code>Lock lock = new ReentrantLock(true)</code>表示非公平锁，后来的也可能先获得锁，<strong>默认为非公平锁</strong>。</li></ul><h3 id="_2-4-1-为什么要有公平锁与非公平锁" tabindex="-1"><a class="header-anchor" href="#_2-4-1-为什么要有公平锁与非公平锁" aria-hidden="true">#</a> 2.4.1 为什么要有公平锁与非公平锁？</h3><p>答：公平与非公平各有优劣，更具不同的情况使用不同的锁。如果为了更高的吞吐量，很显然非公平锁是比较合适的，因为节省了很多线程切换的时间，吞吐量自然就上去了；否则就用公平锁，大家公平使用。</p><p>非公平锁能更充分地利用CPU的时间片，尽量减少CPU空间状态时间。</p><h3 id="_2-4-2-为什么默认是非公平的" tabindex="-1"><a class="header-anchor" href="#_2-4-2-为什么默认是非公平的" aria-hidden="true">#</a> 2.4.2 为什么默认是非公平的？</h3><p>使用多线程很重要的考量点是<strong>线程切换的开销</strong>，当采用<strong>非公平锁时</strong>，当一个线程请求锁获取同步状态，然后释放同步状态，所以刚释放锁的线程在此刻再次获取同步状态的概率就变得很大，所以就减少了线程的开销。</p><h2 id="_2-5-各种锁的优缺点" tabindex="-1"><a class="header-anchor" href="#_2-5-各种锁的优缺点" aria-hidden="true">#</a> 2.5 各种锁的优缺点</h2><figure><img src="/my-docs/assets/033991889cf943b181c8314663a14545-029fd480.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="/my-docs/assets/14230e2472c948318addb902e909a4c8-b028db3a.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h1 id="_3、jit编译器对锁的优化" tabindex="-1"><a class="header-anchor" href="#_3、jit编译器对锁的优化" aria-hidden="true">#</a> 3、JIT编译器对锁的优化</h1><h2 id="_3-1-锁消除" tabindex="-1"><a class="header-anchor" href="#_3-1-锁消除" aria-hidden="true">#</a> 3.1 锁消除</h2><p>每次的锁对象都是一个新的对象，无法达到同步的效果。在编译时期会忽略该同步代码块。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//锁消除问题，JIT会无视它，synchronized(o)每次new出来的，都不存在了，非正常的</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------hello LockClearUpDemo&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-2-锁粗化" tabindex="-1"><a class="header-anchor" href="#_3-2-锁粗化" aria-hidden="true">#</a> 3.2 锁粗化</h2><p>同一个对象锁，合并为统一的同步代码块，避免重复的加锁释放锁的操作。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;111111111111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;222222222222&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;333333333333&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;444444444444&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//底层JIT的锁粗化优化</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;111111111111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;222222222222&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;333333333333&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;444444444444&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4-锁的活跃性问题" tabindex="-1"><a class="header-anchor" href="#_4-锁的活跃性问题" aria-hidden="true">#</a> 4.锁的活跃性问题</h1><h2 id="_4-1-哲学家就餐问题-死锁" tabindex="-1"><a class="header-anchor" href="#_4-1-哲学家就餐问题-死锁" aria-hidden="true">#</a> 4.1 哲学家就餐问题-死锁</h2><figure><img src="/my-docs/assets/1649491894753-aa488041-13c1-45a6-a994-154a0aaccf6d-54771714.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>有五位哲学家，围坐在圆桌旁。</p><ul><li>他们只做两件事，思考和吃饭，思考一会吃口饭，吃完饭后接着思考。</li><li>吃饭时要用两根筷子吃，桌上共有 5 根筷子，每位哲学家左右手边各有一根筷子。</li><li>如果筷子被身边的人拿着，自己就得等待</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">chapter02</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">utils<span class="token punctuation">.</span></span><span class="token class-name">Sleeper</span></span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">App</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Chopstick</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token string">&quot;孔子&quot;</span><span class="token punctuation">,</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token string">&quot;孟子&quot;</span><span class="token punctuation">,</span>c2<span class="token punctuation">,</span>c3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token string">&quot;墨子&quot;</span><span class="token punctuation">,</span>c3<span class="token punctuation">,</span>c4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token string">&quot;庄子&quot;</span><span class="token punctuation">,</span>c4<span class="token punctuation">,</span>c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token string">&quot;王阳明&quot;</span><span class="token punctuation">,</span>c5<span class="token punctuation">,</span>c1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 哲学家就餐问题
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Philosophers</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Philosophers</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Chopstick</span> left<span class="token punctuation">;</span>
    <span class="token class-name">Chopstick</span> right<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Philosophers</span><span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> left<span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> right<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;eating......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获得左手筷子</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获得右手筷子</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 吃饭</span>
                    <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 放下右手筷子</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 放下左手筷子</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 筷子类</span>
<span class="token keyword">class</span> <span class="token class-name">Chopstick</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;筷子{&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-2-活锁" tabindex="-1"><a class="header-anchor" href="#_4-2-活锁" aria-hidden="true">#</a> 4.2 活锁</h2><p>活锁出现在两个线程互相改变对方的结束条件，最后谁也无法结束，例如：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLiveLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 期望减到 0 退出循环</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 期望超过 20 退出循环</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3-饥饿" tabindex="-1"><a class="header-anchor" href="#_4-3-饥饿" aria-hidden="true">#</a> 4.3 饥饿</h2><p>很多教程中把饥饿定义为，一个线程由于<strong>优先级太低</strong>，始终得不到 CPU 调度执行，也不能够结束，饥饿的情况不易演示，讲读写锁时会涉及饥饿问题。</p><h2 id="_4-4-reentrantlock" tabindex="-1"><a class="header-anchor" href="#_4-4-reentrantlock" aria-hidden="true">#</a> 4.4 ReentrantLock</h2><p>相对于 synchronized 它具备如下特点</p><ul><li>可中断</li><li>可以设置超时时间</li><li>可以设置为公平锁</li><li>支持多个条件变量</li></ul><p>与 synchronized 一样，都支持可重入</p><p>基本语法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 获取锁</span>
reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 临界区</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 释放锁</span>
    reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="可重入" tabindex="-1"><a class="header-anchor" href="#可重入" aria-hidden="true">#</a> 可重入</h3><p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次获取这把锁</p><p>如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-cmd line-numbers-mode" data-ext="cmd"><pre class="language-cmd"><code>17:59:11.862 [main] c.TestReentrant - execute method1 
17:59:11.865 [main] c.TestReentrant - execute method2 
17:59:11.865 [main] c.TestReentrant - execute method3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="可打断-lock-lockinterruptibly" tabindex="-1"><a class="header-anchor" href="#可打断-lock-lockinterruptibly" aria-hidden="true">#</a> 可打断 lock.lockInterruptibly()</h3><p>示例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//没有竞争就会获取锁</span>
        <span class="token comment">//有竞争就进入阻塞队列等待,但可以被打断</span>
        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//lock.lock(); //不可打断</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;等锁的过程中被打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// main线程获得了lock，后面t1.start中获得锁，会阻塞。</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="锁-可设置-超时-trylock" tabindex="-1"><a class="header-anchor" href="#锁-可设置-超时-trylock" aria-hidden="true">#</a> 锁(可设置)超时（tryLock）</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Philosophers</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// lock.tryLock() 尝试一次获得锁，如果成功返回true，失败返回false</span>
            <span class="token comment">// lock.tryLock(1,TimeUnit.SECONDS) 尝试获得 N 秒锁，如果成功返回true，失败返回false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取立刻失败，返回&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cmd line-numbers-mode" data-ext="cmd"><pre class="language-cmd"><code>2023-07-13 22:29:39,164 INFO [chapter02.Philosophers] - 获得了锁
2023-07-13 22:29:39,166 INFO [chapter02.Philosophers] - 启动...
2023-07-13 22:29:39,166 INFO [chapter02.Philosophers] - 获取立刻失败，返回
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用-trylock-解决哲学家就餐问题" tabindex="-1"><a class="header-anchor" href="#使用-trylock-解决哲学家就餐问题" aria-hidden="true">#</a> 使用 tryLock 解决哲学家就餐问题</h3><p>示例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Chopstick</span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
* 使用 tryLock 解决哲学家死锁问题。
* 哲学家死锁问题主要是，获取left筷子之后，right筷子无法获取。
* 只要每个哲学家发现无法获取第二个筷子直接放下第一个筷子即可解决该场景死锁问题。
*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得左手筷子</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token comment">// 获得右手筷子</span>
                <span class="token comment">// 一旦失败，直接放下left筷子，下一次在抢。</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 吃饭</span>
                        <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        right<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 放下右手筷子</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                left<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 放下左手筷子</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="可设置是否为-公平锁" tabindex="-1"><a class="header-anchor" href="#可设置是否为-公平锁" aria-hidden="true">#</a> (可设置是否为)公平锁</h3><p>公平: 先来就能先执行</p><p>不公平: 不保证先来就先执行</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h1><ul><li><p>B站黑马JUC教学视频：<a href="https://www.bilibili.com/video/BV16J411h7Rd" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV16J411h7Rd<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>B站尚硅谷JUC教学视频：<a href="https://www.bilibili.com/video/BV1ar4y1x727" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1ar4y1x727<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://github.com/Seazean/JavaNotes" target="_blank" rel="noopener noreferrer">https://github.com/Seazean/JavaNotes<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://www.yuque.com/liuyanntes/vx9leh/wlyhor" target="_blank" rel="noopener noreferrer">https://www.yuque.com/liuyanntes/vx9leh/wlyhor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>对象头的解释：<a href="https://www.jianshu.com/p/3d38cba67f8b" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/3d38cba67f8b<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>对象头的解释：<a href="https://zhuanlan.zhihu.com/p/356010805" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/356010805<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>《深入理解Java虚拟机》第三版——周志明</p></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/docs/juc_notes/Java中的锁.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><!----><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Footer test</div><div class="copyright">jimi</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/my-docs/assets/app-5c2ec4fa.js" defer></script>
  </body>
</html>
